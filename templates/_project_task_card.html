<div
  id="task-{{ task.task_id }}"
  class="task"
  data-id="{{ task.task_id }}"
  data-status="{{ task.status }}"
  data-pinned="{{ 1 if task.is_pinned else 0 }}"
  ondragover="dragOver(event)"
  ondrop="dropTask(event)"
>

  <!-- ğŸ”¹ SUMMARY ROW -->
  <div class="task-row task-main"
       onclick="toggleTask('{{ task.task_id }}')">

    <!-- â˜° Drag handle -->
    <span class="drag-handle"
          draggable="true"
          onmousedown="event.stopPropagation()"
          onclick="event.stopPropagation()"
          ondragstart="dragStart(event)"
          title="Drag to reorder">
      â˜°
    </span>

    <!-- âœ… Checkbox -->
    <input type="checkbox"
           {% if task.status == "done" %}checked{% endif %}
           onclick="event.stopPropagation()"
           onchange="updateStatus('{{ task.task_id }}', this.checked ? 'done' : 'open')">

    <!-- ğŸ”º Priority -->
    <span class="priority-icon"
          data-priority="{{ task.priority or 'medium' }}"
          onclick="event.stopPropagation(); cyclePriority(event, '{{ task.task_id }}')"
          title="Change priority">
    </span>

    <button
    type="button"
    class="icon-btn edit-btn"
    title="Edit task"
    onclick="event.stopPropagation(); enableEdit(
      this.closest('.task').querySelector('.task-title'),
      '{{ task.task_id }}'
    )">
    âœï¸
  </button>

    <!-- ğŸ“ Text -->
    <div class="task-text">
      <span class="task-title"
            ondblclick="enableEdit(this, '{{ task.task_id }}')">
        {{ task.task_text }}
      </span>

      {% if task.missed_eisenhower %}
        <span class="badge missed">
          â° Missed on {{ task.eisenhower_plan_date }}
        </span>
      {% endif %}
    </div>

    {% if task.due_date %}
      <span class="due-badge {% if task.due_date < today %}overdue{% endif %}"
            data-due="{{ task.due_date }}">
        ğŸ“… {{ task.due_date }}
      </span>
    {% endif %}

    <div class="flex-spacer"></div>

    <button
      id="send-{{ task.task_id }}"
      class="icon-btn eisenhower-btn {% if task.eisenhower_sent %}sent{% endif %}"
      type="button"
      title="{% if task.eisenhower_sent %}In Eisenhower{% else %}Send to Eisenhower{% endif %}"
      onclick="event.stopPropagation(); openEisenhower('{{ task.task_id }}')">
      ğŸ§ 
    </button>

  </div>

  <!-- ğŸ”½ EXPANDED DETAILS -->
  <div class="task-details">

    <!-- Planning -->
    <div class="task-row task-details-row planning-row">

      <div class="field">
        <label>Start</label>
        <input type="date"
               class="start-date"
               value="{{ task.start_date or '' }}"
               oninput="updatePlanning('{{ task.task_id }}')">
      </div>

      <div class="field">
        <label>Duration</label>
        <input type="number"
               class="duration-days"
               value="{{ task.duration_days or 0 }}"
               oninput="updatePlanning('{{ task.task_id }}')">
      </div>

      <div class="field">
        <label>Planned</label>
        <input type="number"
               value="{{ task.planned_hours or 0 }}"
               onchange="updatePlanned('{{ task.task_id }}', this.value)">
      </div>

      <div class="field">
        <label>Actual</label>
        <input type="number"
               value="{{ task.actual_hours or 0 }}"
               onchange="updateActual('{{ task.task_id }}', this.value)">
      </div>

      <div class="field">
        <select onchange="updateDueTime('{{ task.task_id }}', this.value)">
          {% for h in range(0,24) %}
            <option value="{{ '%02d:00'|format(h) }}"
              {% if task.due_time == '%02d:00'|format(h) %}selected{% endif %}>
              {{ '%02d:00'|format(h) }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="field">
        <select onchange="updateStatus('{{ task.task_id }}', this.value)">
          <option value="open" {% if task.status=='open' %}selected{% endif %}>Open</option>
          <option value="in_progress" {% if task.status=='in_progress' %}selected{% endif %}>In Progress</option>
          <option value="done" {% if task.status=='done' %}selected{% endif %}>Done</option>
        </select>
      </div>
    </div>

    <!-- Actions -->
    <div class="task-row task-details-row action-row">

      <div class="field wide">
        <label>Delegate</label>
        <input type="text"
               maxlength="25"
               value="{{ task.delegated_to or '' }}"
               onchange="updateDelegation('{{ task.task_id }}', this.value)">
      </div>

      <div class="task-actions">
        <button class="save-task-btn">ğŸ’¾ Save</button>
        <button class="icon-btn danger"
                onclick="eliminateTask('{{ task.task_id }}')">
          ğŸ—‘ Delete
        </button>
      </div>
    </div>

  </div>
</div>

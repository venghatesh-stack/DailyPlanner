<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>
    {% if note %}Edit Note{% else %}New Note{% endif %} ‚Äì Scribble
  </title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Scribble styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='scribble.css') }}">
</head>
<body>

  <div class="scribble-editor">
    <div class="meta">
      <a href="{{ url_for('scribble_list') }}">‚Üê Back to notes</a>
    </div>

    <h1>
      {% if note %}
        Edit Note
      {% else %}
        New Note
      {% endif %}
    </h1>

    <!-- Title -->
    <input
      type="text"
      id="title"
      placeholder="Note title"
      value="{{ note.title if note else '' }}"
      autofocus
    >

    <!-- Content -->
    <textarea
      id="content"
      placeholder="Start writing‚Ä¶"
    >{{ note.content if note else '' }}</textarea>

    <!-- Save status -->
    <div id="status" class="meta"></div>

    <!-- Manual save (optional safety) -->
    <button onclick="saveNote()">Save</button>
  </div>

  <script>
    const noteId = {{ note.id|tojson if note else "null" }};
    let saveTimer = null;
    let dirty = false;

    const titleEl = document.getElementById("title");
    const contentEl = document.getElementById("content");
    const statusEl = document.getElementById("status");

    function markDirty() {
      dirty = true;
      statusEl.textContent = "Unsaved changes‚Ä¶";

      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(saveNote, 800);
    }

 titleEl.addEventListener("input", () => {
  if (noteId === null) return; // ‚ùå don't autosave on new note
  markDirty();
});

contentEl.addEventListener("input", () => {
  if (noteId === null) return; // ‚ùå don't autosave on new note
  markDirty();
});

async function saveNote() {
  // üö´ Prevent autosave creating new notes repeatedly
  if (noteId === null && !titleEl.value.trim() && !contentEl.value.trim()) {
    return;
  }

  const payload = {
    id: noteId,
    title: titleEl.value,
    content: contentEl.value
  };

  statusEl.textContent = "Saving‚Ä¶";

  try {
    const res = await fetch("/notes/scribble/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error("Save failed");

    const data = await res.json();

    // ‚úÖ FIRST SAVE ONLY: lock the note ID
    if (noteId === null && data.id) {
      noteId = data.id;
      history.replaceState(null, "", `/notes/scribble/${data.id}`);
    }

    dirty = false;
    statusEl.textContent = "Saved ‚úì";
  } catch (e) {
    console.error(e);
    statusEl.textContent = "Error saving";
  }
}

  </script>

</body>
</html>

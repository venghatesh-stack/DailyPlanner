<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>
    {% if note %}Edit Note{% else %}New Note{% endif %} – Scribble
  </title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Scribble styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='scribble.css') }}">
</head>
<body>

  <div class="scribble-editor">
    <div class="meta">
      <a href="{{ url_for('scribble_list') }}">← Back to notes</a>
    </div>

    <h1>
      {% if note %}
        Edit Note
      {% else %}
        New Note
      {% endif %}
    </h1>

    <!-- Title -->
    <input
      type="text"
      id="title"
      placeholder="Note title"
      value="{{ note.title if note else '' }}"
      autofocus
    >

    <!-- Content -->
    <textarea
      id="content"
      placeholder="Start writing…"
    >{{ note.content if note else '' }}</textarea>

    <!-- Save status -->
    <div id="status" class="meta"></div>

    <!-- Manual save (optional safety) -->
    <button onclick="saveNote()">Save</button>
  </div>

  <script>
    const noteId = {{ note.id|tojson if note else "null" }};
    let saveTimer = null;
    let dirty = false;

    const titleEl = document.getElementById("title");
    const contentEl = document.getElementById("content");
    const statusEl = document.getElementById("status");

    function markDirty() {
      dirty = true;
      statusEl.textContent = "Unsaved changes…";

      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(saveNote, 800);
    }

    titleEl.addEventListener("input", markDirty);
    contentEl.addEventListener("input", markDirty);

    async function saveNote() {
      if (!dirty) return;

      const payload = {
        id: noteId,
        title: titleEl.value,
        content: contentEl.value
      };

      statusEl.textContent = "Saving…";

      try {
        const res = await fetch("/notes/scribble/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("Save failed");

        const data = await res.json();

        // If this was a new note, update URL without reload
        if (!noteId && data.id) {
          history.replaceState(null, "", `/notes/scribble/${data.id}`);
        }

        dirty = false;
        statusEl.textContent = "Saved ✓";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Error saving";
      }
    }

    // Safety: save before leaving page
    window.addEventListener("beforeunload", (e) => {
      if (!dirty) return;
      e.preventDefault();
      e.returnValue = "";
    });
  </script>

</body>
</html>
